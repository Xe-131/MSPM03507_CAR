## Summary
LP-MSPM0G3507 为主控板，TB6612 为电机驱动，以及霍尔编码器进行速度反馈的四轮小车代码。角度传感器为MUP6050。定位功能由幻思创新的UWB 定位套件提供。

##### 最小系统
这部分内容是小车的最基本功能，让轮子转起来。主要实现了小车的速度闭环和角度闭环。其余所有的拓展部分，都是调用小车的角度和速度控制函数。

电机驱动用的是TB6612，一块儿驱动板可以控制两个轮子，控制一个轮子需要5 个引脚：

| 引脚    | 功能  |
| ----- | --- |
| GPIO1 | 正反转 |
| GPIO2 | 正反转 |
| PWM   | 动力  |
| GPIO3 | 测速  |
| GPIO4 | 测速  |
*注：四轮小车为了节省引脚，同侧轮子用的是同一组引脚。*

两个GPIO 可以让电机实现顺时针，逆时针，刹车，空转的效果。顺时针（逆时针）状态下按照手册上的频率发送PWM 波，电机即可转动，转空比调节动力。还有两个GPIO 通过编码器测速，即可知道单个轮子的实时速度。

一块儿驱动板除了有5 X 2 个引脚外，还有一个standby 引脚可以控制两个电机的使能。

**速度闭环：** 设定一个目标速度，然后通过编码器测量得到了轮子的实时速度，就可通过PID 算法实时的直接调整PWM 占空比来使其达到一个固定的速度。这里PID 模块儿输出的是PWM 占空比。

**角度闭环：** 小车通过左右两边差速运动来达到原地转向的目的。比如左轮速度是10，右轮速度是-10，小车便会顺时针原地转向。通过角度传感器（目前用的是MPU6050）获取实时的角度，通过角度PID 算法对目标速度进行增减量，然后用速度PID 输出PWM 占空比即可。

**举例：** 此时目标速度是100 mm/s, 实时速度也是100 mm/s, 目标角度是0 度，实时角度也是0 度。此时小车便会直行。如果此时目标角度突然改变为90 度，此时角度PID 就会输出一个增量x,两边轮子的目标速度就会瞬时改变为100+x 和 100-x ，这样就实现了匀速转向。
**逻辑框图：**
![[./image/Pasted image 20250720163508.png]]
其中now_speed 获取方式：编码器中断计数，定时器中断定时对计数值进行清算得到。
其中now_angle 获取方式：MPU6050 外部中断中读取。

##### 拓展部分
这是基于小车最小系统代码开发的功能，其核心就是调用最小系统提供的设置角度，设置速度函数。

**定位：** 标签以mavlink 协议发送位置信息到串口，MCU 通过移植的mavlink 代码对其进行解析得到实时坐标。

**移动到某个坐标：** 首先将小车正方向与所在坐标系校准（也就是保持小车在某个方向不动等待MPU6050 初始化完毕）。通过目的坐标与现在坐标计算出行进方向，调用角度函数让小车朝向此方向。然后设置速度，让小车驶向目标点，并在过程中实时计算目标方向，实时修正。等到小车与目标点距离在某个误差内，停下即可。
其中行驶速度可以用PID ，距离越远越快，越近越慢。

**按照某个路径行驶：** 路径由多个目标点组成，依次到达每个目标点即可。

##### 代码运行逻辑
进入main 函数开始运行用户代码
- while 前： 
	- 硬件外设的初始化
	- 中断的使能
	- 各个模块初始化
	- 开启等待MPU6050 的定时(一次性)
	- 开启通用定时(周期性)
- 进入while:轮训检测flag

##### 项目结构
- root
	- position/
		- uwb.c
			- 通过MVlink 协议读取标签实时坐标
		- position.c
			- 利用实时坐标和PID 实现小车路径行驶
		- mavlink/
			- 移植协议源码
	- MPU6050/
		- 角度传感器驱动
	- MSPM0/
		- interrupt.c
		- clock.c
			- SysTick 相关
	- motor/
		- motor.c:电机驱动
		- pid.c
	- user/
		- main.c
		- user.c
	- empty.syscfg
		- 图形化配置文件
	- README.md